{"version":3,"sources":["../../src/arnft/arnft.js"],"names":["isMobile","setMatrix","workerScript","ARNft","cameraParaUrl","video","renderer","camera","onLoaded","interpolationFactor","inputWidth","videoWidth","inputHeight","videoHeight","matrixAutoUpdate","markerRoots","canvasProcess","document","createElement","contextProcess","getContext","initRenderer","worker","Worker","onmessage","e","onWorkerMessage","postMessage","type","pw","ph","camera_para","pScale","Math","max","sScale","window","outerWidth","sw","sh","w","h","ox","oy","style","clientWidth","clientHeight","width","height","console","log","setSize","url","root","push","marker","fillStyle","fillRect","drawImage","imageData","getImageData","imagedata","data","buffer","msg","proj","JSON","parse","ratioW","ratioH","f","n","projectionMatrix","end","onFound","onLost","process","index","matrixGL_RH","markerRoot","matrix","visible"],"mappings":";;;;;;;;AAAA;AACA,SAASA,QAAT,EAAmBC,SAAnB,QAAoC,SAApC;AAEA,IAAMC,YAAY,GAAG,sBAArB;AAEA,WAAaC,KAAb;AACE,iBACEC,aADF,EAEEC,KAFF,EAGEC,QAHF,EAIEC,MAJF,EAKEC,QALF,EAMEC,mBANF,EAOE;AAAA;;AAAA;;AACA,SAAKC,UAAL,GAAkBL,KAAK,CAACM,UAAxB;AACA,SAAKC,WAAL,GAAmBP,KAAK,CAACQ,WAAzB;AAEA,SAAKT,aAAL,GAAqBA,aAArB;AACA,SAAKC,KAAL,GAAaA,KAAb;AACA,SAAKC,QAAL,GAAgBA,QAAhB;AACA,SAAKC,MAAL,GAAcA,MAAd;AACA,SAAKC,QAAL,GAAgBA,QAAhB;AAEA,SAAKD,MAAL,CAAYO,gBAAZ,GAA+B,KAA/B;AAEA,SAAKC,WAAL,GAAmB,EAAnB;AAEA,SAAKC,aAAL,GAAqBC,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAArB;AACA,SAAKC,cAAL,GAAsB,KAAKH,aAAL,CAAmBI,UAAnB,CAA8B,IAA9B,CAAtB;AAEA,SAAKC,YAAL;AAEA,SAAKC,MAAL,GAAc,IAAIC,MAAJ,CAAWrB,YAAX,CAAd;;AACA,SAAKoB,MAAL,CAAYE,SAAZ,GAAwB,UAACC,CAAD;AAAA,aAAO,KAAI,CAACC,eAAL,CAAqBD,CAArB,CAAP;AAAA,KAAxB;;AACA,SAAKH,MAAL,CAAYK,WAAZ,CAAwB;AACtBC,MAAAA,IAAI,EAAE,MADgB;AAEtBC,MAAAA,EAAE,EAAE,KAAKA,EAFa;AAGtBC,MAAAA,EAAE,EAAE,KAAKA,EAHa;AAItBC,MAAAA,WAAW,EAAE,KAAK3B,aAJI;AAKtBK,MAAAA,mBAAmB,EAAEA;AALC,KAAxB;AAOD;;AApCH;AAAA;AAAA,WAsCE,wBAAe;AACb,UAAMuB,MAAM,GAAG,MAAMC,IAAI,CAACC,GAAL,CAAS,KAAKxB,UAAd,EAA2B,KAAKE,WAAL,GAAmB,CAApB,GAAyB,CAAnD,CAArB;AACA,UAAMuB,MAAM,GAAGnC,QAAQ,KAAKoC,MAAM,CAACC,UAAP,GAAoB,KAAK3B,UAA9B,GAA2C,CAAlE;AAEA,UAAM4B,EAAE,GAAG,KAAK5B,UAAL,GAAkByB,MAA7B;AACA,UAAMI,EAAE,GAAG,KAAK3B,WAAL,GAAmBuB,MAA9B;AAEA,WAAKK,CAAL,GAAS,KAAK9B,UAAL,GAAkBsB,MAA3B;AACA,WAAKS,CAAL,GAAS,KAAK7B,WAAL,GAAmBoB,MAA5B;AAEA,WAAKH,EAAL,GAAUI,IAAI,CAACC,GAAL,CAAS,KAAKM,CAAd,EAAkB,KAAKC,CAAL,GAAS,CAAV,GAAe,CAAhC,CAAV;AACA,WAAKX,EAAL,GAAUG,IAAI,CAACC,GAAL,CAAS,KAAKO,CAAd,EAAkB,KAAKD,CAAL,GAAS,CAAV,GAAe,CAAhC,CAAV;AAEA,WAAKE,EAAL,GAAU,CAAC,KAAKb,EAAL,GAAU,KAAKW,CAAhB,IAAqB,CAA/B;AACA,WAAKG,EAAL,GAAU,CAAC,KAAKb,EAAL,GAAU,KAAKW,CAAhB,IAAqB,CAA/B;AAEA,WAAKzB,aAAL,CAAmB4B,KAAnB,CAAyBC,WAAzB,GAAuC,KAAKhB,EAAL,GAAU,IAAjD;AACA,WAAKb,aAAL,CAAmB4B,KAAnB,CAAyBE,YAAzB,GAAwC,KAAKhB,EAAL,GAAU,IAAlD;AACA,WAAKd,aAAL,CAAmB+B,KAAnB,GAA2B,KAAKlB,EAAhC;AACA,WAAKb,aAAL,CAAmBgC,MAAnB,GAA4B,KAAKlB,EAAjC;AAEAmB,MAAAA,OAAO,CAACC,GAAR,CACE,gBADF,EAEE,KAAKlC,aAAL,CAAmB+B,KAFrB,EAGE,KAAK/B,aAAL,CAAmBgC,MAHrB;AAMA,WAAK1C,QAAL,CAAc6C,OAAd,CAAsBb,EAAtB,EAA0BC,EAA1B,EAA8B,KAA9B,EA3Ba,CA2BwB;AACtC;AAlEH;AAAA;AAAA,WAoEE,mBAAUa,GAAV,EAAeC,IAAf,EAAqB;AACnBA,MAAAA,IAAI,CAACvC,gBAAL,GAAwB,KAAxB;AAEA,WAAKC,WAAL,CAAiBuC,IAAjB,CAAsBD,IAAtB;AACA,WAAK/B,MAAL,CAAYK,WAAZ,CAAwB;AAAEC,QAAAA,IAAI,EAAE,KAAR;AAAe2B,QAAAA,MAAM,EAAE,QAAQH;AAA/B,OAAxB;AACD;AAzEH;AAAA;AAAA,WA2EE,mBAAU;AACR,WAAKjC,cAAL,CAAoBqC,SAApB,GAAgC,OAAhC;AACA,WAAKrC,cAAL,CAAoBsC,QAApB,CAA6B,CAA7B,EAAgC,CAAhC,EAAmC,KAAK5B,EAAxC,EAA4C,KAAKC,EAAjD;AACA,WAAKX,cAAL,CAAoBuC,SAApB,CACE,KAAKrD,KADP,EAEE,CAFF,EAGE,CAHF,EAIE,KAAKK,UAJP,EAKE,KAAKE,WALP,EAME,KAAK8B,EANP,EAOE,KAAKC,EAPP,EAQE,KAAKH,CARP,EASE,KAAKC,CATP;AAYA,UAAMkB,SAAS,GAAG,KAAKxC,cAAL,CAAoByC,YAApB,CAAiC,CAAjC,EAAoC,CAApC,EAAuC,KAAK/B,EAA5C,EAAgD,KAAKC,EAArD,CAAlB;AACA,WAAKR,MAAL,CAAYK,WAAZ,CAAwB;AAAEC,QAAAA,IAAI,EAAE,SAAR;AAAmBiC,QAAAA,SAAS,EAAEF;AAA9B,OAAxB,EAAmE,CACjEA,SAAS,CAACG,IAAV,CAAeC,MADkD,CAAnE;AAGD;AA9FH;AAAA;AAAA,WAgGE,yBAAgBtC,CAAhB,EAAmB;AACjB,UAAMuC,GAAG,GAAGvC,CAAC,CAACqC,IAAd;;AACA,cAAQE,GAAG,CAACpC,IAAZ;AACE,aAAK,QAAL;AAAe;AACb,gBAAMqC,IAAI,GAAGC,IAAI,CAACC,KAAL,CAAWH,GAAG,CAACC,IAAf,CAAb;AACA,gBAAMG,MAAM,GAAG,KAAKvC,EAAL,GAAU,KAAKW,CAA9B;AACA,gBAAM6B,MAAM,GAAG,KAAKvC,EAAL,GAAU,KAAKW,CAA9B;AACA,gBAAM6B,CAAC,GAAG,MAAV;AACA,gBAAMC,CAAC,GAAG,GAAV;AAEAN,YAAAA,IAAI,CAAC,CAAD,CAAJ,IAAWG,MAAX;AACAH,YAAAA,IAAI,CAAC,CAAD,CAAJ,IAAWI,MAAX;AACAJ,YAAAA,IAAI,CAAC,EAAD,CAAJ,GAAW,EAAEK,CAAC,IAAIA,CAAC,GAAGC,CAAR,CAAH,CAAX;AACAN,YAAAA,IAAI,CAAC,EAAD,CAAJ,GAAW,EAAGK,CAAC,GAAGC,CAAL,IAAWD,CAAC,GAAGC,CAAf,CAAF,CAAX;AAEAtE,YAAAA,SAAS,CAAC,KAAKM,MAAL,CAAYiE,gBAAb,EAA+BP,IAA/B,CAAT;AAEA,iBAAKzD,QAAL,CAAcwD,GAAd;AACA;AACD;;AACD,aAAK,YAAL;AAAmB;AACjB,gBAAIA,GAAG,CAACS,GAAJ,KAAY,IAAhB,EAAsB;AACpBxB,cAAAA,OAAO,CAACC,GAAR,CAAYc,GAAZ;AACD;;AACD;AACD;;AACD,aAAK,OAAL;AAAc;AACZf,YAAAA,OAAO,CAACC,GAAR,CAAY,OAAZ,EAAqBc,GAArB;AACA,iBAAKU,OAAL,CAAaV,GAAb;AACA;AACD;;AACD,aAAK,MAAL;AAAa;AACXf,YAAAA,OAAO,CAACC,GAAR,CAAY,MAAZ,EAAoBc,GAApB;AACA,iBAAKW,MAAL,CAAYX,GAAZ;AACA;AACD;AAjCH;;AAmCA,WAAKY,OAAL;AACD;AAtIH;AAAA;AAAA,WAwIE,iBAAQZ,GAAR,EAAa;AACX,UAAQa,KAAR,GAA+Bb,GAA/B,CAAQa,KAAR;AAAA,UAAeC,WAAf,GAA+Bd,GAA/B,CAAec,WAAf;AAEA,UAAMC,UAAU,GAAG,KAAKhE,WAAL,CAAiB8D,KAAjB,CAAnB;AACA,UAAMG,MAAM,GAAGd,IAAI,CAACC,KAAL,CAAWW,WAAX,CAAf;AAEAC,MAAAA,UAAU,CAACE,OAAX,GAAqB,IAArB;AACAhF,MAAAA,SAAS,CAAC8E,UAAU,CAACC,MAAZ,EAAoBA,MAApB,CAAT;AACD;AAhJH;AAAA;AAAA,WAkJE,gBAAOhB,GAAP,EAAY;AACV,UAAQa,KAAR,GAAkBb,GAAlB,CAAQa,KAAR;AAEA,UAAME,UAAU,GAAG,KAAKhE,WAAL,CAAiB8D,KAAjB,CAAnB;AAEAE,MAAAA,UAAU,CAACE,OAAX,GAAqB,KAArB;AACD;AAxJH;;AAAA;AAAA","sourcesContent":["/* eslint-disable camelcase */\nimport { isMobile, setMatrix } from \"./utils\"\n\nconst workerScript = \"./js/arnft.worker.js\"\n\nexport class ARNft {\n  constructor(\n    cameraParaUrl,\n    video,\n    renderer,\n    camera,\n    onLoaded,\n    interpolationFactor,\n  ) {\n    this.inputWidth = video.videoWidth\n    this.inputHeight = video.videoHeight\n\n    this.cameraParaUrl = cameraParaUrl\n    this.video = video\n    this.renderer = renderer\n    this.camera = camera\n    this.onLoaded = onLoaded\n\n    this.camera.matrixAutoUpdate = false\n\n    this.markerRoots = []\n\n    this.canvasProcess = document.createElement(\"canvas\")\n    this.contextProcess = this.canvasProcess.getContext(\"2d\")\n\n    this.initRenderer()\n\n    this.worker = new Worker(workerScript)\n    this.worker.onmessage = (e) => this.onWorkerMessage(e)\n    this.worker.postMessage({\n      type: \"load\",\n      pw: this.pw,\n      ph: this.ph,\n      camera_para: this.cameraParaUrl,\n      interpolationFactor: interpolationFactor,\n    })\n  }\n\n  initRenderer() {\n    const pScale = 320 / Math.max(this.inputWidth, (this.inputHeight / 3) * 4)\n    const sScale = isMobile() ? window.outerWidth / this.inputWidth : 1\n\n    const sw = this.inputWidth * sScale\n    const sh = this.inputHeight * sScale\n\n    this.w = this.inputWidth * pScale\n    this.h = this.inputHeight * pScale\n\n    this.pw = Math.max(this.w, (this.h / 3) * 4)\n    this.ph = Math.max(this.h, (this.w / 4) * 3)\n\n    this.ox = (this.pw - this.w) / 2\n    this.oy = (this.ph - this.h) / 2\n\n    this.canvasProcess.style.clientWidth = this.pw + \"px\"\n    this.canvasProcess.style.clientHeight = this.ph + \"px\"\n    this.canvasProcess.width = this.pw\n    this.canvasProcess.height = this.ph\n\n    console.log(\n      \"processCanvas:\",\n      this.canvasProcess.width,\n      this.canvasProcess.height,\n    )\n\n    this.renderer.setSize(sw, sh, false) // do not update css styles\n  }\n\n  addMarker(url, root) {\n    root.matrixAutoUpdate = false\n\n    this.markerRoots.push(root)\n    this.worker.postMessage({ type: \"add\", marker: \"../\" + url })\n  }\n\n  process() {\n    this.contextProcess.fillStyle = \"black\"\n    this.contextProcess.fillRect(0, 0, this.pw, this.ph)\n    this.contextProcess.drawImage(\n      this.video,\n      0,\n      0,\n      this.inputWidth,\n      this.inputHeight,\n      this.ox,\n      this.oy,\n      this.w,\n      this.h,\n    )\n\n    const imageData = this.contextProcess.getImageData(0, 0, this.pw, this.ph)\n    this.worker.postMessage({ type: \"process\", imagedata: imageData }, [\n      imageData.data.buffer,\n    ])\n  }\n\n  onWorkerMessage(e) {\n    const msg = e.data\n    switch (msg.type) {\n      case \"loaded\": {\n        const proj = JSON.parse(msg.proj)\n        const ratioW = this.pw / this.w\n        const ratioH = this.ph / this.h\n        const f = 2000.0\n        const n = 0.1\n\n        proj[0] *= ratioW\n        proj[5] *= ratioH\n        proj[10] = -(f / (f - n))\n        proj[14] = -((f * n) / (f - n))\n\n        setMatrix(this.camera.projectionMatrix, proj)\n\n        this.onLoaded(msg)\n        break\n      }\n      case \"endLoading\": {\n        if (msg.end === true) {\n          console.log(msg)\n        }\n        break\n      }\n      case \"found\": {\n        console.log(\"found\", msg)\n        this.onFound(msg)\n        break\n      }\n      case \"lost\": {\n        console.log(\"lost\", msg)\n        this.onLost(msg)\n        break\n      }\n    }\n    this.process()\n  }\n\n  onFound(msg) {\n    const { index, matrixGL_RH } = msg\n\n    const markerRoot = this.markerRoots[index]\n    const matrix = JSON.parse(matrixGL_RH)\n\n    markerRoot.visible = true\n    setMatrix(markerRoot.matrix, matrix)\n  }\n\n  onLost(msg) {\n    const { index } = msg\n\n    const markerRoot = this.markerRoots[index]\n\n    markerRoot.visible = false\n  }\n}\n"],"file":"arnft.js"}