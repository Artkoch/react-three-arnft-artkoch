{"version":3,"file":"arnft.js","names":["isMobile","setMatrix","workerScript","ARNft","cameraParamUrl","video","renderer","camera","onLoaded","interpolationFactor","inputWidth","videoWidth","inputHeight","videoHeight","matrixAutoUpdate","markers","canvasProcess","document","createElement","contextProcess","getContext","initRenderer","worker","Worker","onmessage","e","onWorkerMessage","postMessage","type","pw","ph","pScale","Math","max","sScale","window","outerWidth","sw","sh","w","h","ox","oy","style","clientWidth","clientHeight","width","height","console","log","setSize","forEach","marker","root","map","url","fillStyle","fillRect","drawImage","imageData","getImageData","imagedata","data","buffer","msg","proj","JSON","parse","ratioW","ratioH","f","n","projectionMatrix","end","process","onMarkerInfos","onFound","onLost","markerInfos","markerInfo","id","children","position","x","dpi","y","matrix","matrixGL_RH","index","i","visible"],"sources":["../../src/arnft/arnft.js"],"sourcesContent":["/* eslint-disable camelcase */\nimport { isMobile, setMatrix } from \"./utils\"\n\nconst workerScript = \"./js/arnft.worker.js\"\n\nexport class ARNft {\n  constructor(\n    cameraParamUrl,\n    video,\n    renderer,\n    camera,\n    onLoaded,\n    interpolationFactor,\n  ) {\n    this.inputWidth = video.videoWidth\n    this.inputHeight = video.videoHeight\n\n    this.cameraParamUrl = cameraParamUrl\n    this.video = video\n    this.renderer = renderer\n    this.camera = camera\n    this.onLoaded = onLoaded\n\n    this.camera.matrixAutoUpdate = false\n\n    this.markers = []\n\n    this.canvasProcess = document.createElement(\"canvas\")\n    this.contextProcess = this.canvasProcess.getContext(\"2d\")\n\n    this.initRenderer()\n\n    this.worker = new Worker(workerScript)\n    this.worker.onmessage = (e) => this.onWorkerMessage(e)\n    this.worker.postMessage({\n      type: \"load\",\n      pw: this.pw,\n      ph: this.ph,\n      cameraParamUrl: this.cameraParamUrl,\n      interpolationFactor: interpolationFactor,\n    })\n  }\n\n  initRenderer() {\n    const pScale = 320 / Math.max(this.inputWidth, (this.inputHeight / 3) * 4)\n    const sScale = isMobile() ? window.outerWidth / this.inputWidth : 1\n\n    const sw = this.inputWidth * sScale\n    const sh = this.inputHeight * sScale\n\n    this.w = this.inputWidth * pScale\n    this.h = this.inputHeight * pScale\n\n    this.pw = Math.max(this.w, (this.h / 3) * 4)\n    this.ph = Math.max(this.h, (this.w / 4) * 3)\n\n    this.ox = (this.pw - this.w) / 2\n    this.oy = (this.ph - this.h) / 2\n\n    this.canvasProcess.style.clientWidth = this.pw + \"px\"\n    this.canvasProcess.style.clientHeight = this.ph + \"px\"\n    this.canvasProcess.width = this.pw\n    this.canvasProcess.height = this.ph\n\n    console.log(\n      \"processCanvas:\",\n      this.canvasProcess.width,\n      this.canvasProcess.height,\n    )\n\n    this.renderer.setSize(sw, sh, false) // false -> do not update css styles\n  }\n\n  loadMarkers(markers) {\n    markers.forEach((marker) => (marker.root.matrixAutoUpdate = false))\n\n    this.markers = markers\n    this.worker.postMessage({\n      type: \"loadMarkers\",\n      markers: markers.map((marker) => marker.url),\n    })\n  }\n\n  process() {\n    this.contextProcess.fillStyle = \"black\"\n    this.contextProcess.fillRect(0, 0, this.pw, this.ph)\n    this.contextProcess.drawImage(\n      this.video,\n      0,\n      0,\n      this.inputWidth,\n      this.inputHeight,\n      this.ox,\n      this.oy,\n      this.w,\n      this.h,\n    )\n\n    const imageData = this.contextProcess.getImageData(0, 0, this.pw, this.ph)\n    this.worker.postMessage({ type: \"process\", imagedata: imageData }, [\n      imageData.data.buffer,\n    ])\n  }\n\n  onWorkerMessage(e) {\n    const msg = e.data\n    switch (msg.type) {\n      case \"loaded\": {\n        const proj = JSON.parse(msg.proj)\n        const ratioW = this.pw / this.w\n        const ratioH = this.ph / this.h\n        const f = 2000.0\n        const n = 0.1\n\n        proj[0] *= ratioW\n        proj[5] *= ratioH\n        proj[10] = -(f / (f - n))\n        proj[14] = -((f * n) / (f - n))\n\n        setMatrix(this.camera.projectionMatrix, proj)\n\n        this.onLoaded(msg)\n        break\n      }\n      case \"markersLoaded\": {\n        if (msg.end === true) {\n          console.log(msg)\n        }\n        this.process()\n        break\n      }\n      case \"markerInfos\": {\n        this.onMarkerInfos(msg.markers)\n        break\n      }\n      case \"found\": {\n        console.log(\"found\", msg)\n        this.onFound(msg)\n        break\n      }\n      case \"lost\": {\n        console.log(\"lost\", msg)\n        this.onLost(msg)\n        break\n      }\n      case \"processNext\": {\n        this.process()\n        break\n      }\n    }\n  }\n\n  onMarkerInfos(markerInfos) {\n    console.log(\"markerInfos\", markerInfos)\n    markerInfos.forEach((markerInfo) => {\n      this.markers[markerInfo.id].root.children[0].position.x =\n        ((markerInfo.width / markerInfo.dpi) * 2.54 * 10) / 2.0\n      this.markers[markerInfo.id].root.children[0].position.y =\n        ((markerInfo.height / markerInfo.dpi) * 2.54 * 10) / 2.0\n    })\n  }\n\n  onFound(msg) {\n    const matrix = JSON.parse(msg.matrixGL_RH)\n    const index = JSON.parse(msg.index)\n\n    setMatrix(this.markers[index].root.matrix, matrix)\n\n    this.markers.forEach((marker, i) => {\n      marker.root.visible = i === index\n    })\n  }\n\n  onLost(msg) {\n    this.markers.forEach((marker) => {\n      marker.root.visible = false\n    })\n  }\n}\n"],"mappings":"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"}