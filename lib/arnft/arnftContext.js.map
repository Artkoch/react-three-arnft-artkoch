{"version":3,"file":"arnftContext.js","names":["React","createContext","useMemo","useContext","useEffect","useRef","useState","useCallback","useThree","ARNft","constraints","audio","video","facingMode","width","height","ARNftContext","ARNftProvider","children","interpolationFactor","arEnabled","gl","camera","arnft","setARNft","markersRef","arnftRef","onLoaded","msg","console","log","current","init","navigator","mediaDevices","getUserMedia","stream","srcObject","onloadedmetadata","event","srcElement","videoWidth","videoHeight","play","domElement","style","objectFit","updateProjectionMatrix","loadMarkers","value","useARNft","arValue","useNftMarker","url","ref","newMarkers","root"],"sources":["../../src/arnft/arnftContext.js"],"sourcesContent":["import React, {\n  createContext,\n  useMemo,\n  useContext,\n  useEffect,\n  useRef,\n  useState,\n  useCallback,\n} from \"react\"\nimport { useThree } from \"@react-three/fiber\"\nimport { ARNft } from \"./arnft\"\n\nconst constraints = {\n  audio: false,\n  video: {\n    facingMode: \"environment\",\n    width: 640,\n    height: 480,\n  },\n}\n\nconst ARNftContext = createContext({})\n\nconst ARNftProvider = ({ children, video, interpolationFactor, arEnabled }) => {\n  const { gl, camera } = useThree()\n\n  const [arnft, setARNft] = useState(null)\n\n  const markersRef = useRef([])\n  const arnftRef = useRef()\n\n  const onLoaded = useCallback((msg) => {\n    console.log(\"onLoaded\", msg)\n\n    setARNft(arnftRef.current)\n  }, [])\n\n  useEffect(() => {\n    async function init() {\n      const stream = await navigator.mediaDevices.getUserMedia(constraints)\n      video.current.srcObject = stream\n      video.current.onloadedmetadata = async (event) => {\n        console.log(event.srcElement.videoWidth)\n        console.log(event.srcElement.videoHeight)\n\n        video.current.play()\n\n        gl.domElement.width = event.srcElement.videoWidth\n        gl.domElement.height = event.srcElement.videoHeight\n\n        gl.domElement.style.objectFit = \"cover\"\n\n        camera.updateProjectionMatrix()\n\n        const arnft = new ARNft(\n          \"../data/camera_para.dat\",\n          video.current,\n          gl,\n          camera,\n          onLoaded,\n          interpolationFactor,\n        )\n\n        arnftRef.current = arnft\n      }\n    }\n\n    if (arEnabled) {\n      init()\n    }\n  }, [])\n\n  useEffect(() => {\n    if (!arnft) {\n      return\n    }\n\n    arnft.loadMarkers(markersRef.current)\n  }, [arnft])\n\n  const value = useMemo(() => {\n    return { arnft, markersRef, arEnabled }\n  }, [arnft, markersRef, arEnabled])\n\n  return <ARNftContext.Provider value={value}>{children}</ARNftContext.Provider>\n}\n\nconst useARNft = () => {\n  const arValue = useContext(ARNftContext)\n  return useMemo(() => ({ ...arValue }), [arValue])\n}\n\nconst useNftMarker = (url) => {\n  const ref = useRef()\n\n  const { markersRef } = useARNft()\n\n  useEffect(() => {\n    const newMarkers = [...markersRef.current, { url, root: ref.current }]\n    markersRef.current = newMarkers\n  }, [])\n\n  return ref\n}\n\nexport { ARNftProvider, useARNft, useNftMarker, ARNftContext }\n"],"mappings":"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"}